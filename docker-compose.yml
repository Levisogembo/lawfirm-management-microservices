services:
    http-api-gateway:
      build: ./http-api-gateway
      ports:
        - "3000:3000"
      env_file:
        - .env
      command: npm run start:prod
      environment:
        - PORT=3000
      networks: 
        - backend
      depends_on:
        - nats

    users_microservice:
      build: ./users-microservice
      env_file:
        - .env
      command: npm run start:prod
      networks: 
        - backend
      depends_on:
        - nats
        - mysql_db

    cases_microservice:
      build: ./cases-microservice
      env_file:
        - .env
      command: npm run start:prod
      networks: 
        - backend
      depends_on:
        - nats
        - mysql_db

    email_microservice:
      build: ./email-microservice
      env_file:
        - .env
      command: npm run start:prod
      networks: 
        - backend
      

    tasks_microservice:
      build: ./tasks-microservice
      env_file:
        - .env
      command: npm run start:prod
      networks: 
        - backend
      depends_on:
        - nats
        - mysql_db

    visitors_microservice:
      build: ./visitors-microservice
      env_file:
        - .env
      command: npm run start:prod
      networks: 
        - backend
      depends_on:
        - nats
        - mysql_db

    nats:
      image: nats
      ports:
        - "4222:4222"
      networks:
        backend:
          aliases:
            - nats.service.local

    mysql_db:
      image: mysql
      ports: 
        - "3306:3306"
      environment:
        - MYSQL_ROOT_PASSWORD_FILE=/run/secrets/mysql_root_password
        - MYSQL_DATABASE_FILE=/run/secrets/mysql_database
        - MYSQL_USER_FILE=/run/secrets/mysql_user
        - MYSQL_PASSWORD_FILE=/run/secrets/mysql_password
        - MYSQL_TCP_PORT=3306
      volumes:
        - mysql_data:/var/lib/mysql
        - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql

        ##mounting secrets file to the containers
        - ./secrets/mysql_root_password:/run/secrets/mysql_root_password
        - ./secrets/mysql_database:/run/secrets/mysql_database
        - ./secrets/mysql_user:/run/secrets/mysql_user
        - ./secrets/mysql_password:/run/secrets/mysql_password
      networks: 
        - backend

networks:
  backend: 
    driver: bridge
  

volumes:
  mysql_data: